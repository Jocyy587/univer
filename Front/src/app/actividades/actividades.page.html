<ion-header [translucent]="true">
  <ion-toolbar>
    <ion-title>actividades</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true">

  <!-- ====================================================== -->
  <!-- VISTA PARA PROFESOR / ADMIN (DISEÑO ORIGINAL)          -->
  <!-- ====================================================== -->
  <ng-container *ngIf="(isStudent$ | async) === false">
    <!-- Formas Decorativas de Fondo -->
    <div class="decorative-shapes">
      <div class="shape green shape-1"></div>
      <div class="shape circle orange shape-2"></div>
      <div class="shape green shape-3"></div>
      <div class="shape orange shape-4"></div>
    </div>

    <section class="module-line-separator top-line">
      <div class="line-with-circles"></div>
    </section>
    <section class="final-title-section">
      <div class="interleaved-title">
        <span class="letter green">A</span><ion-icon name="leaf-outline" class="leaf-separator green"></ion-icon>
        <span class="letter green">C</span><ion-icon name="leaf-outline" class="leaf-separator green"></ion-icon>
        <span class="letter green">T</span><ion-icon name="leaf-outline" class="leaf-separator green"></ion-icon>
        <span class="letter green">I</span><ion-icon name="leaf-outline" class="leaf-separator green"></ion-icon>
        <span class="letter green">V</span><ion-icon name="leaf-outline" class="leaf-separator green"></ion-icon>
        <span class="letter green">I</span><ion-icon name="leaf-outline" class="leaf-separator green"></ion-icon>
        <span class="letter green">D</span><ion-icon name="leaf-outline" class="leaf-separator green"></ion-icon>
        <span class="letter green">A</span><ion-icon name="leaf-outline" class="leaf-separator green"></ion-icon>
        <span class="letter green">D</span><ion-icon name="leaf-outline" class="leaf-separator green"></ion-icon>
        <span class="letter green">E</span><ion-icon name="leaf-outline" class="leaf-separator green"></ion-icon>
        <span class="letter green">S</span>
      </div>
    </section>
    <section class="module-line-separator bottom-line">
      <div class="line-with-circles"></div>
    </section>

    <!-- Donut Chart Sticker -->
    <div class="chart-container">
      <canvas #donutCanvas></canvas>
      <ion-icon name="leaf-outline" class="chart-center-icon"></ion-icon>
    </div>

    <!-- Sección de Tarjetas de Estado -->
    <div class="trello-board">
    <section class="task-cards-section">
      <!-- Card 1: To-do -->
      <ion-card class="task-card">
        <ion-card-header><ion-card-title>ASIGNACION</ion-card-title></ion-card-header>
        <ion-card-content>
          <!-- Tareas de Estudiantes -->
          <h3 class="subsection-title" *ngIf="todoTasks.length > 0 || todoAsignaciones.length > 0">Tareas de Estudiantes</h3>
          <ion-accordion-group *ngIf="todoTasks.length > 0" [multiple]="true" class="ion-margin-bottom">
            <ion-accordion *ngFor="let task of todoTasks; let i = index" [value]="'todo-student-' + i">
              <div class="accordion-header-wrapper" slot="header">
                <div class="accordion-main-content"><ion-label>{{ task.nombre }}</ion-label></div>
                <ion-icon name="leaf-outline" class="header-leaf-icon"></ion-icon>
              </div>
              <div class="ion-padding" slot="content">
                <p>{{ task.descripcion }}</p>
                <div class="task-meta-info">
                  <ion-note>Creado por: {{ task.creador.nombre }}</ion-note><br>
                  <ion-note>Fecha: {{ task.fechaCreacion | date:'dd/MM/yyyy, h:mm a' }}</ion-note>
                  <div *ngIf="task.colaboradores && task.colaboradores.length > 0" class="collaborators-list">
                    <ion-note>Colaboradores: {{ getCollaboratorNames(task) }}</ion-note>
                  </div>
                </div>
                <div class="task-actions" *ngIf="canManageTask(task)">
                  <ion-button fill="clear" size="small" (click)="openEditTaskModal(task)"><ion-icon slot="start" name="create-outline"></ion-icon>Editar</ion-button>
                  <ion-button fill="clear" size="small" color="danger" (click)="deleteTask(task.id, task.creador.id)">Eliminar</ion-button>
                </div>
              </div>
            </ion-accordion>
          </ion-accordion-group>

          <!-- Asignaciones de Maestros -->
          <h3 class="subsection-title" *ngIf="todoTasks.length > 0 || todoAsignaciones.length > 0">Asignaciones de Maestros</h3>
          <ion-accordion-group *ngIf="todoAsignaciones.length > 0" [multiple]="true">
            <ion-accordion *ngFor="let task of todoAsignaciones; let i = index" [value]="'todo-teacher-' + i">
              <div class="accordion-header-wrapper" slot="header">
                <div class="accordion-main-content"><ion-label>{{ task.nombre }}</ion-label></div>
                <ion-icon name="leaf-outline" class="header-leaf-icon"></ion-icon>
              </div>
              <div class="ion-padding" slot="content">
                <p>{{ task.descripcion }}</p>
                <div class="task-meta-info">
                  <ion-note>Creado por: {{ task.creador.nombre }}</ion-note><br>
                  <ion-note>Fecha: {{ task.fechaCreacion | date:'dd/MM/yyyy, h:mm a' }}</ion-note>
                  <div *ngIf="task.colaboradores && task.colaboradores.length > 0" class="collaborators-list">
                    <ion-note>Colaboradores: {{ getCollaboratorNames(task) }}</ion-note>
                  </div>
                </div>
                <div class="task-actions" *ngIf="canManageTask(task)">
                  <ion-button fill="clear" size="small" (click)="openEditTaskModal(task)"><ion-icon slot="start" name="create-outline"></ion-icon>Editar</ion-button>
                  <ion-button fill="clear" size="small" color="danger" (click)="deleteTask(task.id, task.creador.id, 'asignacion')"><ion-icon slot="start" name="trash-outline"></ion-icon>Eliminar</ion-button>
                </div>
              </div>
            </ion-accordion>
          </ion-accordion-group>

          <div *ngIf="todoTasks.length === 0 && todoAsignaciones.length === 0" class="empty-state-card">
            <ion-icon name="sunny-outline"></ion-icon>
            <p>No hay nada pendiente.</p>
          </div>
        </ion-card-content>
      </ion-card>

      <div class="card-separator">
        <div class="separator-circle top"></div><ion-icon name="leaf-outline" class="separator-leaf top-left"></ion-icon><ion-icon name="leaf-outline" class="separator-leaf top-right"></ion-icon><div class="separator-circle bottom"></div>
      </div>

      <!-- Card 2: Doing -->
      <ion-card class="task-card">
        <ion-card-header><ion-card-title>ASIGNACION EN REVISION</ion-card-title></ion-card-header>
        <ion-card-content>
          <!-- Tareas de Estudiantes -->
          <h3 class="subsection-title" *ngIf="doingTasks.length > 0 || doingAsignaciones.length > 0">Tareas de Estudiantes</h3>
          <ion-accordion-group *ngIf="doingTasks.length > 0" [multiple]="true" class="ion-margin-bottom">
            <ion-accordion *ngFor="let task of doingTasks; let i = index" [value]="'doing-student-' + i">
              <div class="accordion-header-wrapper" slot="header">
                <div class="accordion-main-content"><ion-label>{{ task.nombre }}</ion-label></div>
                <ion-icon name="leaf-outline" class="header-leaf-icon"></ion-icon>
              </div>
              <div class="ion-padding" slot="content">
                <p>{{ task.descripcion }}</p>
                <div class="task-meta-info">
                  <ion-note>Creado por: {{ task.creador.nombre }}</ion-note><br>
                  <ion-note>Fecha: {{ task.fechaCreacion | date:'dd/MM/yyyy, h:mm a' }}</ion-note>
                  <div *ngIf="task.colaboradores && task.colaboradores.length > 0" class="collaborators-list">
                    <ion-note>Colaboradores: {{ getCollaboratorNames(task) }}</ion-note>
                  </div>
                </div>
                <ion-list *ngIf="task.entregas && task.entregas.length > 0" class="submission-list">
                  <ion-item *ngFor="let entrega of task.entregas" lines="full" class="submission-item">
                    <ion-label><h3>{{ entrega.studentNombre }}</h3></ion-label>
                    <ion-button *ngIf="entrega.estado === 'Entregado' && canManageTask(task)" slot="end" fill="clear" (click)="openGradeModal(entrega, task.id)">
                      <ion-icon slot="icon-only" name="checkmark-done-circle-outline"></ion-icon>
                    </ion-button>
                  </ion-item>
                </ion-list>
              </div>
            </ion-accordion>
          </ion-accordion-group>

          <!-- Asignaciones de Maestros -->
          <h3 class="subsection-title" *ngIf="doingTasks.length > 0 || doingAsignaciones.length > 0">Asignaciones de Maestros</h3>
          <ion-accordion-group *ngIf="doingAsignaciones.length > 0" [multiple]="true">
            <ion-accordion *ngFor="let task of doingAsignaciones; let i = index" [value]="'doing-teacher-' + i">
              <div class="accordion-header-wrapper" slot="header">
                <div class="accordion-main-content"><ion-label>{{ task.nombre }}</ion-label></div>
                <ion-icon name="leaf-outline" class="header-leaf-icon"></ion-icon>
              </div>
              <div class="ion-padding" slot="content">
                <p>{{ task.descripcion }}</p>
                <div class="task-meta-info">
                  <ion-note>Creado por: {{ task.creador.nombre }}</ion-note><br>
                  <ion-note>Fecha: {{ task.fechaCreacion | date:'dd/MM/yyyy, h:mm a' }}</ion-note>
                  <div *ngIf="task.colaboradores && task.colaboradores.length > 0" class="collaborators-list">
                    <ion-note>Colaboradores: {{ getCollaboratorNames(task) }}</ion-note>
                  </div>
                </div>
                <ion-list *ngIf="task.entregas && task.entregas.length > 0" class="submission-list">
                  <ion-item *ngFor="let entrega of task.entregas" lines="full" class="submission-item">
                    <ion-label><h3>{{ entrega.teacherNombre || entrega.teacherId }}</h3></ion-label>
                    <!-- Si el usuario es admin, muestra el botón para revisar. Si no, muestra un badge. -->
                    <ion-button *ngIf="!(isStudent$ | async)" slot="end" fill="clear" (click)="openReviewModal(entrega, task.id)">
                      <ion-icon slot="icon-only" name="checkmark-done-circle-outline"></ion-icon>
                    </ion-button>
                    <ion-badge *ngIf="(isStudent$ | async)" color="success" slot="end">Completado</ion-badge>
                  </ion-item>
                </ion-list>
              </div>
            </ion-accordion>
          </ion-accordion-group>

          <div *ngIf="doingTasks.length === 0 && doingAsignaciones.length === 0" class="empty-state-card">
            <ion-icon name="reader-outline"></ion-icon>
            <p>No hay nada en revisión.</p>
          </div>
        </ion-card-content>
      </ion-card>

      <div class="card-separator">
        <div class="separator-circle top"></div><ion-icon name="leaf-outline" class="separator-leaf top-left"></ion-icon><ion-icon name="leaf-outline" class="separator-leaf top-right"></ion-icon><div class="separator-circle bottom"></div>
      </div>

      <!-- Card 3: Done -->
      <ion-card class="task-card">
        <ion-card-header><ion-card-title>ASIGNACION REVISADO</ion-card-title></ion-card-header>
        <ion-card-content>
          <!-- Tareas de Estudiantes -->
          <h3 class="subsection-title" *ngIf="doneTasks.length > 0 || doneAsignaciones.length > 0">Tareas de Estudiantes</h3>
          <ion-accordion-group *ngIf="doneTasks.length > 0" [multiple]="true" class="ion-margin-bottom">
            <ion-accordion *ngFor="let task of doneTasks; let i = index" [value]="'done-student-' + i">
              <div class="accordion-header-wrapper" slot="header">
                <div class="accordion-main-content"><ion-label>{{ task.nombre }}</ion-label></div>
                <ion-icon name="leaf-outline" class="header-leaf-icon"></ion-icon>
              </div>
              <div class="ion-padding" slot="content">
                <p>Todas las entregas de esta tarea han sido calificadas.</p>
                <div class="task-meta-info">
                  <ion-note>Creado por: {{ task.creador.nombre }}</ion-note><br>
                  <ion-note>Fecha: {{ task.fechaCreacion | date:'dd/MM/yyyy, h:mm a' }}</ion-note>
                  <div *ngIf="task.colaboradores && task.colaboradores.length > 0" class="collaborators-list">
                    <ion-note>Colaboradores: {{ getCollaboratorNames(task) }}</ion-note>
                  </div>
                </div>
                <ion-list *ngIf="task.entregas && task.entregas.length > 0" class="submission-list">
                  <ion-item *ngFor="let entrega of task.entregas" lines="full" class="submission-item">
                    <ion-label>
                      <h3>{{ entrega.studentNombre }}</h3>
                      <p>Calificación: <strong>{{ entrega.calificacion.nota }}</strong></p>
                    </ion-label>
                  </ion-item>
                </ion-list>
              </div>
            </ion-accordion>
          </ion-accordion-group>

          <!-- Asignaciones de Maestros (Generalmente vacío para esta vista) -->
          <h3 class="subsection-title" *ngIf="doneTasks.length > 0 || doneAsignaciones.length > 0">Asignaciones de Maestros</h3>
          <ion-accordion-group *ngIf="doneAsignaciones.length > 0" [multiple]="true">
            <ion-accordion *ngFor="let task of doneAsignaciones; let i = index" [value]="'done-teacher-' + i">
              <div class="accordion-header-wrapper" slot="header">
                <div class="accordion-main-content"><ion-label>{{ task.nombre }}</ion-label></div>
                <ion-icon name="leaf-outline" class="header-leaf-icon"></ion-icon>
              </div>
              <div class="ion-padding" slot="content">
                <p>Esta asignación ha sido completada por todos los colaboradores asignados.</p>
                <div class="task-meta-info">
                  <ion-note>Creado por: {{ task.creador.nombre }}</ion-note><br>
                  <ion-note>Fecha: {{ task.fechaCreacion | date:'dd/MM/yyyy, h:mm a' }}</ion-note>
                  <div *ngIf="task.colaboradores && task.colaboradores.length > 0" class="collaborators-list">
                    <ion-note>Colaboradores: {{ getCollaboratorNames(task) }}</ion-note>
                  </div>
                </div>
              </div>
              <ion-list *ngIf="task.entregas && task.entregas.length > 0" class="submission-list">
                <ion-item *ngFor="let entrega of task.entregas" lines="full" class="submission-item">
                  <ion-label>
                    <h3>{{ entrega.teacherNombre || entrega.teacherId }}</h3>
                    <p>Estado: <ion-badge [color]="entrega.estado === 'Rechazado' ? 'danger' : 'success'">{{ entrega.estado }}</ion-badge></p>
                  </ion-label>
                </ion-item>
              </ion-list>
            </ion-accordion>
          </ion-accordion-group>

          <div *ngIf="doneTasks.length === 0 && doneAsignaciones.length === 0" class="empty-state-card">
            <ion-icon name="school-outline"></ion-icon>
            <p>No hay nada revisado.</p>
                  </div>
        </ion-card-content>
      </ion-card>
    </section>
    </div>
  </ng-container>

  <!-- ====================================================== -->
  <!-- VISTA PARA ESTUDIANTE (NUEVO DISEÑO)                   -->
  <!-- ====================================================== -->
  <ng-container *ngIf="(isStudent$ | async)">
    <!-- Usamos el nuevo componente reutilizable -->
    <app-student-activitie></app-student-activitie>
  </ng-container>

  <!-- Botón flotante para agregar tareas (solo para admin/Profesor) -->
  <ion-fab vertical="bottom" horizontal="end" slot="fixed" *ngIf="canCreateTasks$ | async">
    <ion-fab-button (click)="openAddTaskModal()">
      <ion-icon name="add-outline"></ion-icon>
    </ion-fab-button>
  </ion-fab>
</ion-content>
