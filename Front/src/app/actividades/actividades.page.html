<ion-header [translucent]="true">
  <ion-toolbar>
    <ion-title>actividades</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true">

  <!-- ====================================================== -->
  <!-- VISTA PARA PROFESOR / ADMIN (DISEÑO ORIGINAL)          -->
  <!-- ====================================================== -->
  <ng-container *ngIf="(isStudent$ | async) === false">
    <!-- Formas Decorativas de Fondo -->
    <div class="decorative-shapes">
      <div class="shape green shape-1"></div>
      <div class="shape circle orange shape-2"></div>
      <div class="shape green shape-3"></div>
      <div class="shape orange shape-4"></div>
    </div>

    <section class="module-line-separator top-line">
      <div class="line-with-circles"></div>
    </section>
    <section class="final-title-section">
      <div class="interleaved-title">
        <span class="letter green">A</span><ion-icon name="leaf-outline" class="leaf-separator green"></ion-icon>
        <span class="letter green">C</span><ion-icon name="leaf-outline" class="leaf-separator green"></ion-icon>
        <span class="letter green">T</span><ion-icon name="leaf-outline" class="leaf-separator green"></ion-icon>
        <span class="letter green">I</span><ion-icon name="leaf-outline" class="leaf-separator green"></ion-icon>
        <span class="letter green">V</span><ion-icon name="leaf-outline" class="leaf-separator green"></ion-icon>
        <span class="letter green">I</span><ion-icon name="leaf-outline" class="leaf-separator green"></ion-icon>
        <span class="letter green">D</span><ion-icon name="leaf-outline" class="leaf-separator green"></ion-icon>
        <span class="letter green">A</span><ion-icon name="leaf-outline" class="leaf-separator green"></ion-icon>
        <span class="letter green">D</span><ion-icon name="leaf-outline" class="leaf-separator green"></ion-icon>
        <span class="letter green">E</span><ion-icon name="leaf-outline" class="leaf-separator green"></ion-icon>
        <span class="letter green">S</span>
      </div>
    </section>
    <section class="module-line-separator bottom-line">
      <div class="line-with-circles"></div>
    </section>

    <!-- Donut Chart Sticker -->
    <div class="chart-container">
      <canvas #donutCanvas></canvas>
      <ion-icon name="leaf-outline" class="chart-center-icon"></ion-icon>
    </div>

    <!-- Sección de Tarjetas de Estado -->
    <section class="task-cards-section">
      <!-- Card 1: To-do -->
      <ion-card class="task-card">
        <ion-card-header><ion-card-title>ASIGNACION</ion-card-title></ion-card-header>
        <ion-card-content>
          <!-- Contenido del acordeón para To-do -->
          <ion-accordion-group *ngIf="todoTasks.length > 0" [multiple]="true">
            <ion-accordion *ngFor="let task of todoTasks; let i = index" [value]="'todo-' + i">
              <div class="accordion-header-wrapper" slot="header">
                <div class="accordion-main-content"><ion-label>{{ task.nombre }}</ion-label></div>
                <ion-icon name="leaf-outline" class="header-leaf-icon"></ion-icon>
              </div>
              <div class="ion-padding" slot="content">
                <p>{{ task.descripcion }}</p>
                <!-- Información adicional de la tarea -->
                <div class="task-meta-info">
                  <ion-note>Creado por: {{ task.creador.nombre }}</ion-note><br>
                  <ion-note>Fecha: {{ task.fechaCreacion | date:'dd/MM/yyyy, h:mm a' }}</ion-note>
                  <div *ngIf="task.colaboradores && task.colaboradores.length > 0" class="collaborators-list">
                    <ion-note>Colaboradores: {{ getCollaboratorNames(task) }}</ion-note>
                  </div>
                </div>
                <!-- Botones de acción -->
                <div class="task-actions" *ngIf="canManageTask(task)">
                  <!-- Botón de Editar Tarea -->
                  <ion-button fill="clear" size="small" class="edit-task-button" (click)="openEditTaskModal(task); $event.stopPropagation();">
                    <ion-icon slot="start" name="duplicate-outline"></ion-icon>
                    Editar
                  </ion-button>
                  <!-- Botón de Eliminar Tarea -->
                  <ion-button fill="clear" size="small" color="danger" class="delete-task-button" (click)="deleteTask(task.id, task.creador.id); $event.stopPropagation();">
                    <ion-icon slot="start" name="trash-outline"></ion-icon>
                    Eliminar
                  </ion-button>
                </div>
              </div>
            </ion-accordion>
          </ion-accordion-group>
        </ion-card-content>
      </ion-card>

      <div class="card-separator">
        <div class="separator-circle top"></div><ion-icon name="leaf-outline" class="separator-leaf top-left"></ion-icon><ion-icon name="leaf-outline" class="separator-leaf top-right"></ion-icon><div class="separator-circle bottom"></div>
      </div>

      <!-- Card 2: Doing -->
      <ion-card class="task-card">
        <ion-card-header><ion-card-title>ASIGNACION EN REVISION</ion-card-title></ion-card-header>
        <ion-card-content>
          <!-- Contenido del acordeón para Doing -->
          <ion-accordion-group *ngIf="doingTasks.length > 0" [multiple]="true">
            <ion-accordion *ngFor="let task of doingTasks; let i = index" [value]="'doing-' + i">
              <!-- Cabecera de la Tarea -->
              <div class="accordion-header-wrapper" slot="header">
                <div class="accordion-main-content"><ion-label>{{ task.nombre }}</ion-label></div>
                <ion-icon name="leaf-outline" class="header-leaf-icon"></ion-icon>
              </div>
              <!-- Contenido de la Tarea: Lista de Entregas -->
              <div class="ion-padding" slot="content">
                <p>{{ task.descripcion }}</p>
                <!-- Información adicional de la tarea -->
                <div class="task-meta-info">
                  <ion-note>Creado por: {{ task.creador.nombre }}</ion-note><br>
                  <ion-note>Fecha: {{ task.fechaCreacion | date:'dd/MM/yyyy, h:mm a' }}</ion-note>
                  <div *ngIf="task.colaboradores && task.colaboradores.length > 0" class="collaborators-list">
                    <ion-note>Colaboradores: {{ getCollaboratorNames(task) }}</ion-note>
                  </div>
                </div>

                <!-- Sub-lista de entregas de estudiantes -->
                <ion-list *ngIf="task.entregas && task.entregas.length > 0" class="submission-list">
                  <ion-item *ngFor="let entrega of task.entregas" lines="full" class="submission-item">
                    <ion-label>
                      <h3>{{ entrega.studentNombre }}</h3>
                      <p>Entregado: {{ entrega.entrega.fecha | date:'short' }}</p>
                      <p *ngIf="entrega.estado === 'Calificado'">Calificación: {{ entrega.calificacion.nota }}</p>
                    </ion-label>
                    <!-- CORRECCIÓN: El botón con slot="icon-only" se auto-cierra -->
                    <ion-button *ngIf="entrega.estado === 'Entregado' && canManageTask(task)" slot="end" fill="clear" (click)="openGradeModal(entrega, task.id)"><ion-icon slot="icon-only" name="checkmark-done-circle-outline"></ion-icon></ion-button>
                  </ion-item>
                </ion-list>

                <!-- Botones de acción para la sección "Doing" -->
                <div class="task-actions" *ngIf="canManageTask(task)">
                  <!-- Botón de Editar Tarea -->
                  <ion-button fill="clear" size="small" class="edit-task-button" (click)="openEditTaskModal(task); $event.stopPropagation();">
                    <ion-icon slot="start" name="duplicate-outline"></ion-icon>
                    Editar
                  </ion-button>
                  <!-- Botón de Eliminar Tarea -->
                  <ion-button fill="clear" size="small" color="danger" class="delete-task-button" (click)="deleteTask(task.id, task.creador.id); $event.stopPropagation();">
                    <ion-icon slot="start" name="trash-outline"></ion-icon>
                    Eliminar
                  </ion-button>
                </div>
              </div>
            </ion-accordion>
          </ion-accordion-group>
        </ion-card-content>
      </ion-card>

      <div class="card-separator">
        <div class="separator-circle top"></div><ion-icon name="leaf-outline" class="separator-leaf top-left"></ion-icon><ion-icon name="leaf-outline" class="separator-leaf top-right"></ion-icon><div class="separator-circle bottom"></div>
      </div>

      <!-- Card 3: Done -->
      <ion-card class="task-card">
        <ion-card-header><ion-card-title>ASIGNACION REVISADO</ion-card-title></ion-card-header>
        <ion-card-content>
          <!-- Contenido del acordeón para Done -->
          <ion-accordion-group *ngIf="doneTasks.length > 0" [multiple]="true">
            <ion-accordion *ngFor="let task of doneTasks; let i = index" [value]="'done-' + i">
              <div class="accordion-header-wrapper" slot="header">
                <div class="accordion-main-content"><ion-label>{{ task.nombre }}</ion-label></div>
                <ion-icon name="leaf-outline" class="header-leaf-icon"></ion-icon>
              </div>
              <div class="ion-padding" slot="content">
                <p>{{ task.descripcion }}</p>
                <!-- Información adicional de la tarea -->
                <div class="task-meta-info">
                  <ion-note>Creado por: {{ task.creador.nombre }}</ion-note><br>
                  <ion-note>Fecha: {{ task.fechaCreacion | date:'dd/MM/yyyy, h:mm a' }}</ion-note>
                  <div *ngIf="task.colaboradores && task.colaboradores.length > 0" class="collaborators-list">
                    <ion-note>Colaboradores: {{ getCollaboratorNames(task) }}</ion-note>
                  </div>
                </div>

                <!-- Lista de entregas y calificaciones para tareas revisadas -->
                <ion-list *ngIf="task.entregas && task.entregas.length > 0" class="submission-list">
                  <ion-item *ngFor="let entrega of task.entregas" lines="full" class="submission-item">
                    <ion-label>
                      <h3>{{ entrega.studentNombre }}</h3>
                      <p>Entregado: {{ entrega.entrega.fecha | date:'short' }}</p>
                      <p *ngIf="entrega.estado === 'Calificado'">Calificación: <strong>{{ entrega.calificacion.nota }}</strong></p>
                    </ion-label>
                  </ion-item>
                </ion-list>

                <!-- Botones de acción para la sección "Done" -->
                <div class="task-actions" *ngIf="canManageTask(task)">
                  <!-- Botón de Eliminar Tarea (solo para el creador o admin) -->
                  <ion-button *ngIf="isAdmin || task.creador.id === currentUserId" fill="clear" size="small" color="danger" class="delete-task-button" (click)="deleteTask(task.id, task.creador.id); $event.stopPropagation();">
                    <ion-icon slot="start" name="trash-outline"></ion-icon>
                    Eliminar
                  </ion-button>
                </div>

              </div>
            </ion-accordion>
          </ion-accordion-group>
        </ion-card-content>
      </ion-card>
    </section>
  </ng-container>

  <!-- ====================================================== -->
  <!-- VISTA PARA ESTUDIANTE (NUEVO DISEÑO)                   -->
  <!-- ====================================================== -->
  <ng-container *ngIf="(isStudent$ | async)">
    <!-- Usamos el nuevo componente reutilizable -->
    <app-student-activitie></app-student-activitie>
  </ng-container>

  <!-- Botón flotante para agregar tareas (solo para admin/Profesor) -->
  <ion-fab vertical="bottom" horizontal="end" slot="fixed" *ngIf="canCreateTasks$ | async">
    <ion-fab-button (click)="openAddTaskModal()">
      <ion-icon name="add-outline"></ion-icon>
    </ion-fab-button>
  </ion-fab>
</ion-content>
